name: Test Job

on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install allure-pytest

      - name: Create environment file
        run: |
          cat > .env << EOF
          POSTGRES_USER=${{ vars.POSTGRES_USER || 'postgres' }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD || 'password' }}
          POSTGRES_DB_AUTH=${{ vars.POSTGRES_DB_AUTH || 'auth_db' }}
          POSTGRES_DB_UNIVERSITY=${{ vars.POSTGRES_DB_UNIVERSITY || 'university_db' }}
          UNIVERSITY_SERVICE_INTERNAL_URL=${{ vars.UNIVERSITY_SERVICE_INTERNAL_URL || 'http://university:8000' }}
          UNIVERSITY_SERVICE_API_URL=${{ vars.UNIVERSITY_SERVICE_API_URL || 'http://localhost:8001' }}
          AUTH_SERVICE_INTERNAL_URL=${{ vars.AUTH_SERVICE_INTERNAL_URL || 'http://auth:8000' }}
          AUTH_SERVICE_API_URL=${{ vars.AUTH_SERVICE_API_URL || 'http://localhost:8000' }}
          EOF

      - name: Start services
        run: |
          docker-compose up -d
        
      - name: Run tests with Allure
        run: |
          echo "=== RUNNING TESTS ==="
          mkdir -p allure-results
          python -m pytest tests/ -v --alluredir=allure-results

      - name: Stop services
        if: always()
        run: |
          echo "=== STOPPING SERVICES ==="
          docker-compose down
